# Detect crawlers/bots for SSR
map $http_user_agent $is_crawler {
    default                     0;
    ~*googlebot                 1;
    ~*bingbot                   1;
    ~*slurp                     1;
    ~*duckduckbot               1;
    ~*baiduspider               1;
    ~*yandexbot                 1;
    ~*facebookexternalhit       1;
    ~*twitterbot                1;
    ~*linkedinbot               1;
    ~*applebot                  1;
    ~*discordbot                1;
    ~*telegrambot               1;
    ~*whatsapp                  1;
    ~*pinterest                 1;
    ~*slackbot                  1;
}

server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript;

    # SEO: robots.txt
    location = /robots.txt {
        try_files $uri =404;
        add_header Cache-Control "public, max-age=86400";
    }

    # SEO: sitemap.xml - proxy to backend
    location = /sitemap.xml {
        proxy_pass http://abiotic-backend:8080/api/sitemap.xml;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        add_header Cache-Control "public, max-age=3600";
    }

    # SSR for entity pages - only for crawlers (SEO)
    # Real users get the SPA directly for better performance
    location ~ ^/(item|npc|compendium|dialogue)/([^/]+)$ {
        # Redirect crawlers to internal SSR location
        if ($is_crawler) {
            rewrite ^/(item|npc|compendium|dialogue)/([^/]+)$ /internal-ssr/$1/$2 last;
        }
        # Real users: serve SPA directly
        try_files $uri /index.html;
    }

    # Internal SSR proxy (not accessible directly)
    location ^~ /internal-ssr/ {
        internal;
        rewrite ^/internal-ssr/(item|npc|compendium|dialogue)/([^/]+)$ /api/ssr/$1/$2 break;
        proxy_pass http://abiotic-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Cache-Control "public, max-age=3600";
    }

    # SPA routing - serve index.html for all routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Serve optimized WebP icons (primary)
    location ^~ /icons-webp/ {
        alias /app/data/icons-webp/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "image/webp";
    }

    # Serve original PNG icons (fallback)
    location ^~ /icons/ {
        alias /app/data/icons/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Serve NPC icons from Compendium
    location ^~ /npc-icons/ {
        alias /app/data/GUI/Compendium/Entries/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Serve Compendium images
    location ^~ /compendium/ {
        alias /app/data/GUI/Compendium/Entries/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Cache static assets (exclude /api paths)
    location ~* ^(?!/api/).*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API proxy to backend
    location /api {
        proxy_pass http://abiotic-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # Pass Pangolin auth headers
        proxy_set_header Remote-User $http_remote_user;
        proxy_set_header Remote-Email $http_remote_email;
        proxy_set_header Remote-Name $http_remote_name;
        proxy_cache_bypass $http_upgrade;
    }
}
